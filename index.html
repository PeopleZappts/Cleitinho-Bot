<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const send = document.getElementById("send");

  function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.className = "message " + sender;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    send.currentTime = 0;
    send.volume = 0.3;
    send.play().catch(error => console.log('Erro ao tocar send:', error));
  }

  function showTyping() {
    const div = document.createElement("div");
    div.className = "typing";
    div.id = "typing";
    div.innerHTML = "<span></span><span></span><span></span>";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function removeTyping() {
    const typing = document.getElementById("typing");
    if (typing) typing.remove();
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    appendMessage(text, "user");
    input.value = "";
    input.focus();
    showTyping();

    fetch("https://zpt-dev.zappts.com.br/webhook-test/cleitinho-zskill", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ pergunta: text })
    })
    .then(response => {
      if (!response.ok) throw new Error("Resposta invÃ¡lida do servidor");
      return response.json();
    })
    .then(data => {
      removeTyping();
      appendMessage(data.resposta || "ðŸ¤– Cleitinho estÃ¡ sem resposta no momento. Tente mais tarde.", "bot");
      localStorage.setItem("cleitinho-history", chat.innerHTML);
    })
    .catch(error => {
      console.error("Erro ao falar com Cleitinho:", error);
      removeTyping();
      appendMessage("ðŸ¤– O Cleitinho travou aqui ðŸ˜… Tenta de novo mais tarde.", "bot");
    });
  }

  window.onload = () => {
    const history = localStorage.getItem("cleitinho-history");
    if (history) chat.innerHTML = history;
    chat.scrollTop = chat.scrollHeight;
  };

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });
</script>

